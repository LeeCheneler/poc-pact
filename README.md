# Pact proof of concept

# What is Pact

Pact is a tool that enabled contract testing between **consumers** and **providers**.

**A pact === a contract.**

See https://pact.io/.

## Prerequisites

In order to build and work in this repository you will need the following tools installed:

- [Node](https://nodejs.org/) - runtime
- [Yarn](https://classic.yarnpkg.com/) - package manager
- [Docker for Mac (or Windows)](https://www.docker.com/) - container runtime

## Getting started

Install dependencies:

```sh
yarn
```

## Generate pact

Pacts are generated by consumers. In this POC the consumer is a node script that fetches a list of todos from an API (the provider) and logs them out. In reality a consumer is usually a web application or an API.

- `packages/consumer/src/main.ts` - contains a function that fetches todos from an API.
- `packages/consumer/src/__tests__/main.test.ts` - contains a test that starts a Pact provider locally and adds an **interaction** to it. This interaction describes what is expected to be sent to and recieved from the provider's API.

**Run the tests to generate a pact:**

```sh
cd packages/consumer
yarn test
```

Notice that a new folder has been created called `pact/pacts`. This contains our brand new Pact contract!

### Publishing to the pact broker

Pacts are stored in a centralised service called the pact broker. Consumers publish contracts to it, and providers pull down their relevant pacts and assert against them.

First you need to start the pact broker. There is a docker compise file in the root of the directory that spins up a pact broker locally.

**Start the pact broker in docker:**

```sh
docker-compose up
```

Now you should be able to browse to http://localhost:9292 and see the pact broker, noticeably without our new pact published to it. The consumer has a little node scripts to do this.

**Publish consumer pacts:**

```sh
cd packages/consumer
yarn publish
```

Now refresh the pact broker webpage and you should see the new pact! On the right hand side you'll notice the "Last verified" column is empty. Thats because our provider hasn't verified that the it works against the pacts yet.

### Asserting against the pacts

Our provider is a simple Express server that returns a hard code payload of todos. Providers assert against the pacts associated to them. It will pull all of its pacts down from the pact broker and throw test requests at a running instance of the provider to assert it matches the pact.

- `packages/provider/src/main.ts` - simlpe express server with hard coded todo response
- `packages/provider/src/__tests__/main.test.ts` - uses Pacts API to pull down pacts from pact broker and verifies a running instance of the provider against them

**Run the provider locally:**

```sh
cd packages/provider
yarn start --watch
```

Now browse to http://localhost:3000/api/todos and you will see a response with todos.

**Verify pacts against provider:**

```sh
cd packages/provider
yarn test
```

It should pass. Now refresh the pact broker web page and you should see that it now has a green entry in the "Last verified" column.

Now lets see if it really works... change the payload, for instance change all the todo item ids to be strings instead of numbers. The server should restart on its own once you save.

Now rerun the tests and they should fail, then refresh the pact broker web page and you'll see that the "Last verified" column is now flagged red!
